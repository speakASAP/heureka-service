services:
  gateway-proxy:
    image: nginx:alpine
    container_name: heureka-service-gateway-proxy-green
    # Port mapping for health checks only - gateway-proxy is accessed via Docker network (http://gateway-proxy)
    # Host port 3804 (available in 34xx range, mapped to container port 80
    ports:
      - "${GATEWAY_PROXY_PORT:-3804}:80"
    volumes:
      - ./nginx/gateway-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - nginx-network
    depends_on:
      - heureka
      - settings
      - imports
    restart: unless-stopped
    # Note: nginx configuration uses dynamic DNS resolution (resolver + variables in proxy_pass)
    # This prevents stale IP caching when services restart and get new IP addresses
    # DNS is re-resolved every 10 seconds, and variables in proxy_pass force resolution on each request
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "--tries=1", "http://127.0.0.1/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    container_name: heureka-service-api-gateway-green
    ports:
      - "${API_GATEWAY_PORT:-3801}:3801"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - SERVICE_NAME=${SERVICE_NAME:-heureka-service}
      - API_GATEWAY_PORT=${API_GATEWAY_PORT:-3801}
      - HEUREKA_SERVICE_URL=${HEUREKA_SERVICE_URL:-http://heureka:3800}
      - IMPORT_SERVICE_URL=${IMPORT_SERVICE_URL:-http://imports:3802}
      - SETTINGS_SERVICE_URL=${SETTINGS_SERVICE_URL:-http://settings:3803}
      - HEUREKA_SETTINGS_SERVICE_PORT=${HEUREKA_SETTINGS_SERVICE_PORT:-3803}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - NOTIFICATION_SERVICE_URL=${NOTIFICATION_SERVICE_URL}
      - LOGGING_SERVICE_URL=${LOGGING_SERVICE_URL}
      - HTTP_TIMEOUT=${HTTP_TIMEOUT}
      - GATEWAY_TIMEOUT=${GATEWAY_TIMEOUT}
      - CORS_ORIGIN=${CORS_ORIGIN}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-heureka}
      - DATABASE_URL=${DATABASE_URL}
    deploy:
      resources:
        limits:
          memory: 200M
          cpus: '0.5\'
        reservations:
          memory: 70M
    networks:
      - nginx-network
    depends_on:
      - gateway-proxy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3801/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  heureka:
    build:
      context: .
      dockerfile: services/heureka-service/Dockerfile
    container_name: heureka-service-green
    ports:
      - "${HEUREKA_SERVICE_PORT:-3800}:3800"
    volumes:
      - ./logs:/app/logs

    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - SERVICE_NAME=${SERVICE_NAME:-heureka-service}
      - HEUREKA_SERVICE_PORT=${HEUREKA_SERVICE_PORT:-3800}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - NOTIFICATION_SERVICE_URL=${NOTIFICATION_SERVICE_URL}
      - LOGGING_SERVICE_URL=${LOGGING_SERVICE_URL}
      - HEUREKA_CLIENT_ID=${HEUREKA_CLIENT_ID}
      - HEUREKA_CLIENT_SECRET=${HEUREKA_CLIENT_SECRET}
      - HEUREKA_REDIRECT_URI=${HEUREKA_REDIRECT_URI}
      - HEUREKA_AUTH_URL=${HEUREKA_AUTH_URL:-https://heureka.pl/auth/oauth/token}
      - HEUREKA_AUTH_SANDBOX_URL=${HEUREKA_AUTH_SANDBOX_URL}
      - HEUREKA_OAUTH_AUTHORIZE_URL=${HEUREKA_OAUTH_AUTHORIZE_URL}
      - HEUREKA_OAUTH_TOKEN_URL=${HEUREKA_OAUTH_TOKEN_URL}
      - HEUREKA_API_URL=${HEUREKA_API_URL:-https://api.heureka.pl}
      - HEUREKA_API_SANDBOX_URL=${HEUREKA_API_SANDBOX_URL}
      - HEUREKA_USE_SANDBOX=${HEUREKA_USE_SANDBOX:-false}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - CATALOG_SERVICE_URL=${CATALOG_SERVICE_URL:-http://catalog-microservice:3200}
      - WAREHOUSE_SERVICE_URL=${WAREHOUSE_SERVICE_URL:-http://warehouse-microservice:3201}
      - ORDER_SERVICE_URL=${ORDER_SERVICE_URL:-http://orders-microservice:3203}
      - RABBITMQ_URL=${RABBITMQ_URL:-amqp://guest:guest@statex_rabbitmq:5672}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-heureka}
      - DATABASE_URL=${DATABASE_URL}
    networks:
      - nginx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3800/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  imports:
    build:
      context: .
      dockerfile: services/imports/Dockerfile
    container_name: heureka-service-imports-green
    ports:
      - "${IMPORT_SERVICE_PORT:-3802}:3802"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - SERVICE_NAME=${SERVICE_NAME:-heureka-service}
      - IMPORT_SERVICE_PORT=${IMPORT_SERVICE_PORT:-3802}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - NOTIFICATION_SERVICE_URL=${NOTIFICATION_SERVICE_URL}
      - LOGGING_SERVICE_URL=${LOGGING_SERVICE_URL}
      - HEUREKA_SERVICE_URL=${HEUREKA_SERVICE_URL:-http://heureka:3800}
      - IMPORT_CSV_MAX_SIZE=${IMPORT_CSV_MAX_SIZE:-104857600}
      - IMPORT_CSV_BATCH_SIZE=${IMPORT_CSV_BATCH_SIZE:-50}
      - NOTIFICATION_ORDER_CREATED=${NOTIFICATION_ORDER_CREATED:-true}
      - NOTIFICATION_ORDER_UPDATED=${NOTIFICATION_ORDER_UPDATED:-true}
      - NOTIFICATION_STOCK_LOW=${NOTIFICATION_STOCK_LOW:-true}
      - NOTIFICATION_EMAIL_TO=${NOTIFICATION_EMAIL_TO}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-heureka}
      - DATABASE_URL=${DATABASE_URL}
    networks:
      - nginx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3802/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  settings:
    build:
      context: .
      dockerfile: services/settings/Dockerfile
    container_name: heureka-service-settings-green
    ports:
      - "${HEUREKA_SETTINGS_SERVICE_PORT:-3803}:3803"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - SERVICE_NAME=${SERVICE_NAME:-heureka-service}
      - HEUREKA_SETTINGS_SERVICE_PORT=${HEUREKA_SETTINGS_SERVICE_PORT:-3803}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - NOTIFICATION_SERVICE_URL=${NOTIFICATION_SERVICE_URL}
      - LOGGING_SERVICE_URL=${LOGGING_SERVICE_URL}
      - HTTP_TIMEOUT=${HTTP_TIMEOUT}
      - AUTH_SERVICE_TIMEOUT=${AUTH_SERVICE_TIMEOUT}
      - HEUREKA_AUTH_URL=${HEUREKA_AUTH_URL:-https://heureka.pl/auth/oauth/token}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-heureka}
      - DATABASE_URL=${DATABASE_URL}
    networks:
      - nginx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3803/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  frontend:
    build:
      context: .
      dockerfile: services/frontend/Dockerfile
      args:
        - FRONTEND_API_URL=${FRONTEND_API_URL}
    container_name: heureka-service-frontend-green
    ports:
      - "${HEUREKA_FRONTEND_SERVICE_PORT:-3805}:3805"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
    networks:
      - nginx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3805/health"]
      interval: 10s
      timeout: 10s
      retries: 2
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 50M
          cpus: '0.25\'
        reservations:
          memory: 20M
    deploy:
      resources:
        limits:
          memory: 200M
          cpus: '0.5\'
        reservations:
          memory: 70M
    deploy:
      resources:
        limits:
          memory: 200M
          cpus: '0.5\'
        reservations:
          memory: 70M
    deploy:
      resources:
        limits:
          memory: 200M
          cpus: '0.5\'
        reservations:
          memory: 70M
    deploy:
      resources:
        limits:
          memory: 100M
          cpus: '0.5\'
        reservations:
          memory: 50M

networks:
  nginx-network:
    external: true
    name: nginx-network
